name: Relay NBDC Release to ReproSchema

on:
  release:
    types: [released]
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to relay (e.g., 4.0.0)'
        required: true
        type: string

permissions:
  contents: read

jobs:
  relay:
    if: github.repository == 'nbdc-datahub/NBDCtoolsData'
    runs-on: ubuntu-latest
    steps:
      - name: Extract version
        id: version
        run: |
          # Use manual input or release tag
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            VERSION="${{ github.event.inputs.version }}"
          else
            VERSION="${{ github.ref_name }}"
          fi
          VERSION="${VERSION#v}"

          # Validate version format (must be x.x.x)
          if [[ ! $VERSION =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "Error: Invalid version format: $VERSION"
            echo "Expected format: x.x.x (e.g., 4.0.0, 5.0.1)"
            exit 1
          fi

          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Extracted version: $VERSION"

      - name: Generate GitHub App token
        id: app_token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ secrets.NBDC_CHECK_APP_ID }}
          private-key: ${{ secrets.NBDC_CHECK_APP_PRIVATE_KEY }}
          owner: ReproNim
          repositories: |
            ABCD-ReproSchema
            HBCD-ReproSchema

      - name: Trigger ABCD-ReproSchema workflow
        uses: peter-evans/repository-dispatch@v3
        with:
          token: ${{ steps.app_token.outputs.token }}
          repository: ReproNim/ABCD-ReproSchema
          event-type: nbdc-release
          client-payload: |
            {
              "release": "${{ steps.version.outputs.version }}",
              "create_tag": true,
              "source_repo": "${{ github.repository }}",
              "release_url": "${{ github.event.release.html_url || '' }}",
              "triggered_by": "${{ github.actor }}"
            }

      - name: Trigger HBCD-ReproSchema workflow
        uses: peter-evans/repository-dispatch@v3
        with:
          token: ${{ steps.app_token.outputs.token }}
          repository: ReproNim/HBCD-ReproSchema
          event-type: nbdc-release
          client-payload: |
            {
              "release": "${{ steps.version.outputs.version }}",
              "create_tag": true,
              "source_repo": "${{ github.repository }}",
              "release_url": "${{ github.event.release.html_url || '' }}",
              "triggered_by": "${{ github.actor }}"
            }
